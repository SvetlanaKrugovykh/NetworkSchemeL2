<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Network Scheme L2 - Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #4a90e2, #357abd);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
    }

    .header p {
      opacity: 0.9;
      font-size: 1.1em;
    }

    .content {
      padding: 30px;
    }

    .topology-container {
      margin-top: 20px;
      padding: 15px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      background-color: #f9fafb;
    }

    .section {
      margin-bottom: 40px;
    }

    .section h2 {
      color: #333;
      margin-bottom: 20px;
      font-size: 1.8em;
      border-bottom: 2px solid #4a90e2;
      padding-bottom: 10px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }

    .card {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 20px;
      border: 1px solid #e9ecef;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .card h3 {
      color: #4a90e2;
      margin-bottom: 15px;
    }

    .btn {
      background: linear-gradient(135deg, #4a90e2, #357abd);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s;
      text-decoration: none;
      display: inline-block;
      margin: 5px;
    }

    .btn:hover {
      background: linear-gradient(135deg, #357abd, #2968a3);
      transform: translateY(-1px);
    }

    .btn.danger {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
    }

    .btn.success {
      background: linear-gradient(135deg, #27ae60, #229954);
    }

    .status {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 15px;
      font-size: 0.9em;
      margin: 5px;
    }

    .status.loading {
      background: #ffeaa7;
      color: #d63031;
    }

    .status.success {
      background: #55efc4;
      color: #00b894;
    }

    .status.error {
      background: #fd79a8;
      color: #e84393;
    }

    .log {
      background: #2d3748;
      color: #e2e8f0;
      padding: 15px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 10px;
    }

    .input-group {
      margin-bottom: 15px;
    }

    .input-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #333;
    }

    .input-group input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-item {
      text-align: center;
      background: linear-gradient(135deg, #a8e6cf, #7fcdcd);
      padding: 20px;
      border-radius: 10px;
      color: white;
    }

    .stat-number {
      font-size: 2em;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 0.9em;
      opacity: 0.9;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>üåê Network Scheme L2</h1>
      <p>–°–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª—ñ–∑—É –º–µ—Ä–µ–∂–µ–≤–æ—ó —Ç–æ–ø–æ–ª–æ–≥—ñ—ó —Ç–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó —Å—Ö–µ–º VLAN</p>
    </div>

    <div class="content">
      <!-- Statistics -->
      <div class="section">
        <h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
        <div class="stats" id="stats">
          <div class="stat-item">
            <div class="stat-number" id="deviceCount">-</div>
            <div class="stat-label">–ü—Ä–∏—Å—Ç—Ä–æ—ó</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" id="vlanCount">-</div>
            <div class="stat-label">VLAN</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" id="macCount">-</div>
            <div class="stat-label">MAC –∞–¥—Ä–µ—Å–∏</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" id="portCount">-</div>
            <div class="stat-label">–ü–æ—Ä—Ç–∏</div>
          </div>
        </div>
      </div>

      <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏ -->
      <div class="section">
        <h2>üìÅ –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –¥–∞–Ω–∏–º–∏</h2>
        <div class="grid">
          <div class="card">
            <h3>üìÅ –Ü–º–ø–æ—Ä—Ç —Ñ–∞–π–ª—ñ–≤</h3>
            <p>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π —Ç–∞ MAC —Ç–∞–±–ª–∏—Ü—å</p>

            <div class="input-group">
              <label for="deviceIp">IP –ø—Ä–∏—Å—Ç—Ä–æ—é:</label>
              <input type="text" id="deviceIp" placeholder="192.168.1.1">
            </div>

            <div class="input-group">
              <label for="configFile">–§–∞–π–ª –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó (.cfg):</label>
              <input type="file" id="configFile" accept=".cfg,.txt,.conf">
            </div>

            <div class="input-group">
              <label for="macFile">–§–∞–π–ª MAC —Ç–∞–±–ª–∏—Ü—ñ (.mac):</label>
              <input type="file" id="macFile" accept=".mac,.txt">
            </div>

            <button class="btn" onclick="uploadFiles()">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ–∞–π–ª–∏</button>
            <div id="uploadStatus"></div>
          </div>

          <div class="card">
            <h3>üîÑ –Ü–º–ø–æ—Ä—Ç –¥–∞–Ω–∏—Ö</h3>
            <p>–Ü–º–ø–æ—Ä—Ç –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π —Ç–∞ MAC —Ç–∞–±–ª–∏—Ü—å –∑ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó data/</p>
            <button class="btn" onclick="importData()">–Ü–º–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ –¥–∞–Ω—ñ</button>
            <div id="importStatus"></div>
          </div>

          <div class="card">
            <h3>üìã –ü–µ—Ä–µ–≥–ª—è–¥ –ø—Ä–∏—Å—Ç—Ä–æ—ó–≤</h3>
            <p>–°–ø–∏—Å–æ–∫ –≤—Å—ñ—Ö —ñ–º–ø–æ—Ä—Ç–æ–≤–∞–Ω–∏—Ö –º–µ—Ä–µ–∂–µ–≤–∏—Ö –ø—Ä–∏—Å—Ç—Ä–æ—ó–≤</p>
            <button class="btn" onclick="loadDevices()">–ü–æ–∫–∞–∑–∞—Ç–∏ –ø—Ä–∏—Å—Ç—Ä–æ—ó</button>
            <div id="devicesStatus"></div>
          </div>

          <div class="card">
            <h3>üåê –ü–µ—Ä–µ–≥–ª—è–¥ VLAN</h3>
            <p>–°–ø–∏—Å–æ–∫ –≤—Å—ñ—Ö VLAN –≤ –º–µ—Ä–µ–∂—ñ</p>
            <button class="btn" onclick="loadVlans()">–ü–æ–∫–∞–∑–∞—Ç–∏ VLAN</button>
            <div id="vlansStatus"></div>
          </div>
        </div>
      </div>

      <!-- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ö–µ–º -->
      <div class="section">
        <h2>üé® –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è —Å—Ö–µ–º</h2>
        <div class="card">
          <h3>üìä HTML —Å—Ö–µ–º–∞ VLAN</h3>
          <p>–ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –¥–µ—Ç–∞–ª—å–Ω–æ—ó —Å—Ö–µ–º–∏ –ø—Ä–æ—Ö–æ–¥–∂–µ–Ω–Ω—è VLAN —á–µ—Ä–µ–∑ –ø—Ä–∏—Å—Ç—Ä–æ—ó</p>

          <div class="input-group">
            <label for="vlanId">VLAN ID:</label>
            <input type="number" id="vlanId" placeholder="–í–≤–µ–¥—ñ—Ç—å ID VLAN (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, 13)" value="13">
          </div>

          <button class="btn success" onclick="generateVlanScheme()">–ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ —Å—Ö–µ–º—É</button>
          <button class="btn" onclick="viewVlanTopology()">–ü–æ–∫–∞–∑–∞—Ç–∏ —Ç–æ–ø–æ–ª–æ–≥—ñ—é (JSON)</button>
          <button class="btn" onclick="viewVlanMacs()">–ü–æ–∫–∞–∑–∞—Ç–∏ MAC –∞–¥—Ä–µ—Å–∏</button>
        </div>
      </div>

      <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
      <div class="section">
        <h2>üìù –†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h2>
        <div id="results">
          <p>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–ø–µ—Ä–∞—Ü–∏–π –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å...</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.onload = function () {
      loadStats();
    };

    async function loadStats() {
      try {
        const stats = await fetch('/api/stats').then(r => r.json());

        if (stats.success) {
          document.getElementById('deviceCount').textContent = stats.data.devices;
          document.getElementById('vlanCount').textContent = stats.data.vlans;
          document.getElementById('macCount').textContent = stats.data.macs;
          document.getElementById('portCount').textContent = stats.data.ports;
        }

      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }

    async function importData() {
      const statusDiv = document.getElementById('importStatus');
      statusDiv.innerHTML = '<span class="status loading">–Ü–º–ø–æ—Ä—Ç –¥–∞–Ω–∏—Ö...</span>';

      try {
        const response = await fetch('/api/import', { method: 'POST' });
        const result = await response.json();

        if (result.success) {
          statusDiv.innerHTML = `
                        <span class="status success">–£—Å–ø—ñ—à–Ω–æ!</span>
                        <div class="log">
                            –ü—Ä–∏—Å—Ç—Ä–æ—ó–≤ —ñ–º–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ: ${result.results.devicesImported}
                            MAC —Ç–∞–±–ª–∏—Ü—å —ñ–º–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ: ${result.results.macTablesImported}
                            –ü–æ–º–∏–ª–æ–∫: ${result.results.errors.length}
                        </div>
                    `;
          loadStats(); // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        } else {
          statusDiv.innerHTML = `<span class="status error">–ü–æ–º–∏–ª–∫–∞: ${result.error}</span>`;
        }
      } catch (error) {
        statusDiv.innerHTML = `<span class="status error">–ü–æ–º–∏–ª–∫–∞: ${error.message}</span>`;
      }
    }

    async function uploadFiles() {
      const statusDiv = document.getElementById('uploadStatus');
      const deviceIp = document.getElementById('deviceIp').value.trim();
      const configFile = document.getElementById('configFile').files[0];
      const macFile = document.getElementById('macFile').files[0];

      if (!deviceIp) {
        statusDiv.innerHTML = '<span class="status error">–£–∫–∞–∂–∏—Ç–µ IP –∞–¥—Ä–µ—Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</span>';
        return;
      }

      if (!configFile && !macFile) {
        statusDiv.innerHTML = '<span class="status error">–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏</span>';
        return;
      }

      statusDiv.innerHTML = '<span class="status loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤...</span>';

      try {
        const formData = new FormData();
        formData.append('deviceIp', deviceIp);

        if (configFile) {
          formData.append('configFile', configFile);
        }

        if (macFile) {
          formData.append('macFile', macFile);
        }

        const response = await fetch('/api/upload', {
          method: 'POST',
          body: formData
        });

        const result = await response.json();

        if (result.success) {
          let message = '<span class="status success">–§–∞–π–ª–∏ —É—Å–ø—ñ—à–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ!</span><div class="log">';

          if (result.config) {
            message += `–ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è: ${result.config.message}<br>`;
            message += `–¢–∏–ø –ø—Ä–∏—Å—Ç—Ä–æ—é: ${result.config.detected_type || 'Auto'}<br>`;
            if (result.config.stats) {
              message += `–ü–æ—Ä—Ç—ñ–≤: ${result.config.stats.ports_imported}, VLANs: ${result.config.stats.vlans_imported}<br>`;
            }
          }

          if (result.mac) {
            message += `MAC —Ç–∞–±–ª–∏—Ü—è: ${result.mac.message}<br>`;
            if (result.mac.stats) {
              message += `MAC –∑–∞–ø–∏—Å—ñ–≤: ${result.mac.stats.entries_imported}/${result.mac.stats.entries_processed}<br>`;
            }
          }

          message += '</div>';
          statusDiv.innerHTML = message;

          // –û—á–∏—â—É—î–º–æ —Ñ–æ—Ä–º—É
          document.getElementById('configFile').value = '';
          document.getElementById('macFile').value = '';

          // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
          loadStats();
        } else {
          statusDiv.innerHTML = `<span class="status error">–ü–æ–º–∏–ª–∫–∞: ${result.error}</span>`;
        }
      } catch (error) {
        statusDiv.innerHTML = `<span class="status error">–ü–æ–º–∏–ª–∫–∞: ${error.message}</span>`;
      }
    }

    async function loadDevices() {
      const statusDiv = document.getElementById('devicesStatus');
      const resultsDiv = document.getElementById('results');

      try {
        const response = await fetch('/api/devices');
        const result = await response.json();

        if (result.success) {
          statusDiv.innerHTML = `<span class="status success">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ ${result.data.length} –ø—Ä–∏—Å—Ç—Ä–æ—ó–≤</span>`;

          let html = '<h3>üì± –°–µ—Ç–µ–≤—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</h3><div class="grid">';
          result.data.forEach(device => {
            html += `
                            <div class="card">
                                <h4>${device.hostname}</h4>
                                <p><strong>IP:</strong> ${device.ip_address}</p>
                                <p><strong>–¢–∏–ø:</strong> ${device.device_type}</p>
                                <p><strong>–ú–æ–¥–µ–ª—å:</strong> ${device.model || 'N/A'}</p>
                                <button class="btn" onclick="viewDevice(${device.id})">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
                            </div>
                        `;
          });
          html += '</div>';
          resultsDiv.innerHTML = html;
        } else {
          statusDiv.innerHTML = `<span class="status error">–û—à–∏–±–∫–∞: ${result.error}</span>`;
        }
      } catch (error) {
        statusDiv.innerHTML = `<span class="status error">–û—à–∏–±–∫–∞: ${error.message}</span>`;
      }
    }

    async function loadVlans() {
      const statusDiv = document.getElementById('vlansStatus');
      const resultsDiv = document.getElementById('results');

      try {
        const response = await fetch('/api/vlans');
        const result = await response.json();

        if (result.success) {
          statusDiv.innerHTML = `<span class="status success">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ ${result.data.length} VLAN</span>`;

          let html = '<h3>üåê VLAN –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è</h3><div class="grid">';
          result.data.slice(0, 20).forEach(vlan => { // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 20
            html += `
                            <div class="card">
                                <h4>VLAN ${vlan.vlan_id}</h4>
                                <p><strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong> ${vlan.name}</p>
                                <p><strong>–¢–∏–ø:</strong> ${vlan.type}</p>
                                <p>${vlan.description}</p>
                                <button class="btn" onclick="generateVlanScheme(${vlan.vlan_id})">–°—Ö–µ–º–∞</button>
                                <button class="btn" onclick="viewVlanTopology(${vlan.vlan_id})">–¢–æ–ø–æ–ª–æ–≥–∏—è</button>
                            </div>
                        `;
          });
          if (result.data.length > 20) {
            html += `<div class="card"><p>–Ü —â–µ ${result.data.length - 20} VLAN...</p></div>`;
          }
          html += '</div>';
          resultsDiv.innerHTML = html;
        } else {
          statusDiv.innerHTML = `<span class="status error">–ü–æ–º–∏–ª–∫–∞: ${result.error}</span>`;
        }
      } catch (error) {
        statusDiv.innerHTML = `<span class="status error">–ü–æ–º–∏–ª–∫–∞: ${error.message}</span>`;
      }
    }

    function generateVlanScheme(vlanId) {
      if (!vlanId) {
        vlanId = document.getElementById('vlanId').value;
      }

      if (!vlanId) {
        alert('–í–≤–µ–¥–∏—Ç–µ VLAN ID');
        return;
      }

      window.open(`/api/vlans/${vlanId}/scheme`, '_blank');
    }

    async function viewVlanTopology(vlanId) {
      if (!vlanId) {
        vlanId = document.getElementById('vlanId').value;
      }

      if (!vlanId) {
        alert('Enter VLAN ID');
        return;
      }

      try {
        const response = await fetch(`/api/vlans/${vlanId}/topology`);
        const result = await response.json();

        if (result.success) {
          const resultsDiv = document.getElementById('results');
          resultsDiv.innerHTML = `<h3>üîó Network Topology VLAN ${vlanId}</h3>`;

          // Create topology visualization container
          const topologyContainer = document.createElement('div');
          topologyContainer.id = 'topology-visualization';
          topologyContainer.className = 'topology-container';
          resultsDiv.appendChild(topologyContainer);

          // Visualize topology
          visualizeNetworkTopology([result.data]);
        } else {
          alert('Error: ' + result.error);
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    // Network Topology Visualization with Source/Transit Detection
    function visualizeNetworkTopology(data) {
      const container = document.getElementById('topology-visualization')
      container.innerHTML = ''

      if (!data || data.length === 0) {
        container.innerHTML = '<p style="color: #666;">No topology data available</p>'
        return
      }

      // Create main topology container
      const topologyDiv = document.createElement('div')
      topologyDiv.style.display = 'flex'
      topologyDiv.style.flexDirection = 'column'
      topologyDiv.style.gap = '20px'

      data.forEach(item => {
        const vlanSection = document.createElement('div')
        vlanSection.style.border = '1px solid #ddd'
        vlanSection.style.borderRadius = '8px'
        vlanSection.style.padding = '15px'
        vlanSection.style.backgroundColor = '#f9f9f9'

        // VLAN Header
        const vlanHeader = document.createElement('h3')
        vlanHeader.style.margin = '0 0 15px 0'
        vlanHeader.style.color = '#2563eb'
        vlanHeader.textContent = item.vlan_name || ('VLAN ' + item.vlan_id)
        vlanSection.appendChild(vlanHeader)

        // Device grid
        if (item.devices && item.devices.length > 0) {
          const deviceGrid = document.createElement('div')
          deviceGrid.style.display = 'grid'
          deviceGrid.style.gridTemplateColumns = 'repeat(auto-fit, minmax(300px, 1fr))'
          deviceGrid.style.gap = '15px'

          item.devices.forEach(device => {
            const deviceCard = createDeviceCard(device)
            deviceGrid.appendChild(deviceCard)
          })

          vlanSection.appendChild(deviceGrid)
        }

        topologyDiv.appendChild(vlanSection)
      })

      container.appendChild(topologyDiv)
    }

    // Create device card with ports and MAC addresses
    function createDeviceCard(device) {
      const card = document.createElement('div')
      card.style.backgroundColor = 'white'
      card.style.border = '1px solid #ddd'
      card.style.borderRadius = '8px'
      card.style.padding = '15px'
      card.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)'

      // Device header
      const header = document.createElement('div')
      header.style.display = 'flex'
      header.style.alignItems = 'center'
      header.style.marginBottom = '15px'

      const deviceIcon = document.createElement('div')
      deviceIcon.style.width = '32px'
      deviceIcon.style.height = '32px'
      deviceIcon.style.backgroundColor = '#dbeafe'
      deviceIcon.style.borderRadius = '50%'
      deviceIcon.style.display = 'flex'
      deviceIcon.style.alignItems = 'center'
      deviceIcon.style.justifyContent = 'center'
      deviceIcon.style.marginRight = '12px'
      deviceIcon.innerHTML = 'üñ•Ô∏è'

      const deviceInfo = document.createElement('div')
      deviceInfo.innerHTML = `
                <div style="font-weight: 600; color: #1f2937;">${device.hostname || 'Unknown Device'}</div>
                <div style="font-size: 14px; color: #6b7280;">${device.ip_address}</div>
                <div style="font-size: 12px; color: #9ca3af;">${device.device_type || 'Switch'}</div>
            `

      header.appendChild(deviceIcon)
      header.appendChild(deviceInfo)
      card.appendChild(header)

      // Ports section
      if (device.ports && device.ports.length > 0) {
        const portsSection = document.createElement('div')
        portsSection.style.display = 'flex'
        portsSection.style.flexDirection = 'column'
        portsSection.style.gap = '8px'

        device.ports.forEach(port => {
          const portCard = createPortCard(port)
          portsSection.appendChild(portCard)
        })

        card.appendChild(portsSection)
      }

      return card
    }

    // Create port card with MAC addresses and topology info
    function createPortCard(port) {
      const portDiv = document.createElement('div')
      portDiv.style.border = '1px solid #e5e7eb'
      portDiv.style.borderRadius = '6px'
      portDiv.style.padding = '12px'
      portDiv.style.backgroundColor = '#f9fafb'

      // Port header
      const portHeader = document.createElement('div')
      portHeader.style.display = 'flex'
      portHeader.style.justifyContent = 'space-between'
      portHeader.style.alignItems = 'center'
      portHeader.style.marginBottom = '8px'

      const portInfo = document.createElement('div')
      portInfo.style.fontWeight = '500'
      portInfo.style.fontSize = '14px'

      // Show port type for OLT EPON interfaces
      const isEponPort = port.port_number && /epon[\d\-/:.]/.test(port.port_number)
      const portTypeIndicator = isEponPort ? ' üì°' : ''
      portInfo.textContent = `Port ${port.port_number}${portTypeIndicator}`

      const portMode = document.createElement('span')
      portMode.style.padding = '2px 8px'
      portMode.style.borderRadius = '4px'
      portMode.style.fontSize = '12px'
      const modeColor = getModeColor(port.mode)
      portMode.style.backgroundColor = modeColor.bg
      portMode.style.color = modeColor.text
      portMode.textContent = port.mode || 'unknown'

      portHeader.appendChild(portInfo)
      portHeader.appendChild(portMode)
      portDiv.appendChild(portHeader)

      // Port description
      if (port.port_description) {
        const description = document.createElement('div')
        description.style.fontSize = '12px'
        description.style.color = '#6b7280'
        description.style.marginBottom = '8px'
        description.textContent = port.port_description
        portDiv.appendChild(description)
      }

      // MAC addresses with topology indicators
      if (port.mac_addresses && port.mac_addresses.length > 0) {
        const macSection = document.createElement('div')
        macSection.style.display = 'flex'
        macSection.style.flexDirection = 'column'
        macSection.style.gap = '4px'

        // Group MACs by source/transit
        const sourceMacs = port.mac_addresses.filter(mac => mac.is_source)
        const transitMacs = port.mac_addresses.filter(mac => mac.is_source === false)
        const unknownMacs = port.mac_addresses.filter(mac => mac.is_source === null)

        // Source MACs
        if (sourceMacs.length > 0) {
          const sourceHeader = document.createElement('div')
          sourceHeader.style.fontSize = '12px'
          sourceHeader.style.fontWeight = '500'
          sourceHeader.style.color = '#059669'
          sourceHeader.style.marginTop = '8px'
          sourceHeader.textContent = `Source Devices (${sourceMacs.length})`
          macSection.appendChild(sourceHeader)

          sourceMacs.forEach(mac => {
            const macDiv = createMacAddressDiv(mac, 'source')
            macSection.appendChild(macDiv)
          })
        }

        // Transit MACs
        if (transitMacs.length > 0) {
          const transitHeader = document.createElement('div')
          transitHeader.style.fontSize = '12px'
          transitHeader.style.fontWeight = '500'
          transitHeader.style.color = '#d97706'
          transitHeader.style.marginTop = '8px'
          transitHeader.textContent = `Transit Path (${transitMacs.length})`
          macSection.appendChild(transitHeader)

          transitMacs.forEach(mac => {
            const macDiv = createMacAddressDiv(mac, 'transit')
            macSection.appendChild(macDiv)
          })
        }

        // Unknown MACs
        if (unknownMacs.length > 0) {
          const unknownHeader = document.createElement('div')
          unknownHeader.style.fontSize = '12px'
          unknownHeader.style.fontWeight = '500'
          unknownHeader.style.color = '#374151'
          unknownHeader.style.marginTop = '8px'
          unknownHeader.textContent = `Unanalyzed (${unknownMacs.length})`
          macSection.appendChild(unknownHeader)

          unknownMacs.forEach(mac => {
            const macDiv = createMacAddressDiv(mac, 'unknown')
            macSection.appendChild(macDiv)
          })
        }

        portDiv.appendChild(macSection)
      }

      return portDiv
    }

    // Create MAC address div with topology indicators
    function createMacAddressDiv(mac, type) {
      const macDiv = document.createElement('div')
      macDiv.style.display = 'flex'
      macDiv.style.alignItems = 'center'
      macDiv.style.justifyContent = 'space-between'
      macDiv.style.padding = '8px'
      macDiv.style.borderRadius = '4px'
      macDiv.style.fontSize = '12px'
      const typeColor = getMacTypeColor(type)
      macDiv.style.backgroundColor = typeColor.bg
      macDiv.style.border = `1px solid ${typeColor.border}`

      const macInfo = document.createElement('div')
      macInfo.style.display = 'flex'
      macInfo.style.alignItems = 'center'
      macInfo.style.gap = '8px'

      // Topology indicator
      const indicator = document.createElement('div')
      indicator.style.width = '8px'
      indicator.style.height = '8px'
      indicator.style.borderRadius = '50%'
      indicator.style.backgroundColor = getIndicatorColor(type)

      const macText = document.createElement('code')
      macText.style.fontFamily = 'monospace'
      macText.style.fontSize = '11px'
      macText.textContent = mac.mac_address

      macInfo.appendChild(indicator)
      macInfo.appendChild(macText)

      // Additional info
      const additionalInfo = document.createElement('div')
      additionalInfo.style.textAlign = 'right'
      additionalInfo.style.fontSize = '11px'

      if (mac.client_type && mac.client_type !== 'unknown') {
        const clientType = document.createElement('div')
        clientType.style.color = '#6b7280'
        clientType.textContent = mac.client_type.replace('_', ' ')
        additionalInfo.appendChild(clientType)
      }

      if (type === 'transit' && mac.hop_count !== null && mac.hop_count !== undefined) {
        const hopCount = document.createElement('div')
        hopCount.style.color = '#d97706'
        hopCount.textContent = `${mac.hop_count} hops`
        additionalInfo.appendChild(hopCount)
      } else if (type === 'transit') {
        const transitNote = document.createElement('div')
        transitNote.style.color = '#d97706'
        transitNote.textContent = 'transit path'
        additionalInfo.appendChild(transitNote)
      }

      macDiv.appendChild(macInfo)
      macDiv.appendChild(additionalInfo)

      return macDiv
    }

    // Helper functions for styling
    function getModeColor(mode) {
      switch (mode) {
        case 'access': return { bg: '#dcfce7', text: '#166534' }
        case 'trunk': return { bg: '#dbeafe', text: '#1e40af' }
        case 'hybrid': return { bg: '#f3e8ff', text: '#7c3aed' }
        default: return { bg: '#f3f4f6', text: '#374151' }
      }
    }

    function getMacTypeColor(type) {
      switch (type) {
        case 'source': return { bg: '#f0fdf4', border: '#bbf7d0' }
        case 'transit': return { bg: '#fffbeb', border: '#fed7aa' }
        default: return { bg: '#f9fafb', border: '#e5e7eb' }
      }
    }

    function getIndicatorColor(type) {
      switch (type) {
        case 'source': return '#10b981'
        case 'transit': return '#f59e0b'
        default: return '#9ca3af'
      }
    }

    async function viewVlanMacs(vlanId) {
      if (!vlanId) {
        vlanId = document.getElementById('vlanId').value;
      }

      if (!vlanId) {
        alert('–í–≤–µ–¥–∏—Ç–µ VLAN ID');
        return;
      }

      try {
        const response = await fetch(`/api/vlans/${vlanId}/macs`);
        const result = await response.json();

        if (result.success) {
          const resultsDiv = document.getElementById('results');
          let html = `<h3>üè∑Ô∏è MAC –∞–¥—Ä–µ—Å–∞ –≤ VLAN ${vlanId}</h3>`;

          if (result.data.length === 0) {
            html += '<p>MAC –∞–¥—Ä–µ—Å–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
          } else {
            html += '<div class="grid">';
            result.data.forEach(mac => {
              html += `
                                <div class="card">
                                    <h4>${mac.mac_address}</h4>
                                    ${mac.ip_address ? `<p><strong>IP:</strong> ${mac.ip_address}</p>` : ''}
                                    <p><strong>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ:</strong> ${mac.hostname || mac.device_ip}</p>
                                    <p><strong>–ü–æ—Ä—Ç:</strong> ${mac.port_number}</p>
                                    <p><strong>–¢–∏–ø:</strong> ${mac.client_type || 'unknown'}</p>
                                    ${mac.description ? `<p>${mac.description}</p>` : ''}
                                </div>
                            `;
            });
            html += '</div>';
          }

          resultsDiv.innerHTML = html;
        } else {
          alert('–ü–æ–º–∏–ª–∫–∞: ' + result.error);
        }
      } catch (error) {
        alert('–ü–æ–º–∏–ª–∫–∞: ' + error.message);
      }
    }

    async function viewDevice(deviceId) {
      try {
        const response = await fetch(`/api/devices/${deviceId}`);
        const result = await response.json();

        if (result.success) {
          const device = result.data;
          const resultsDiv = document.getElementById('results');

          let html = `
                        <h3>üì± ${device.hostname}</h3>
                        <p><strong>IP:</strong> ${device.ip_address}</p>
                        <p><strong>–¢–∏–ø:</strong> ${device.device_type}</p>
                        <p><strong>–ú–æ–¥–µ–ª—å:</strong> ${device.model}</p>
                        <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${device.status}</p>
                    `;

          if (device.ports && device.ports.length > 0) {
            html += '<h4>üîå –ü–æ—Ä—Ç—ã</h4><div class="grid">';
            device.ports.slice(0, 12).forEach(port => {
              html += `
                                <div class="card">
                                    <h5>Port ${port.port_number}</h5>
                                    <p><strong>–¢–∏–ø:</strong> ${port.port_type}</p>
                                    <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${port.status}</p>
                                    ${port.description ? `<p>${port.description}</p>` : ''}
                                </div>
                            `;
            });
            if (device.ports.length > 12) {
              html += `<div class="card"><p>–ò –µ—â–µ ${device.ports.length - 12} –ø–æ—Ä—Ç–æ–≤...</p></div>`;
            }
            html += '</div>';
          }

          resultsDiv.innerHTML = html;
        } else {
          alert('–ü–æ–º–∏–ª–∫–∞: ' + result.error);
        }
      } catch (error) {
        alert('–ü–æ–º–∏–ª–∫–∞: ' + error.message);
      }
    }
  </script>
</body>

</html>
