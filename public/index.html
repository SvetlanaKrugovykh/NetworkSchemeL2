<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Network Scheme L2 - Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #4a90e2, #357abd);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
    }

    .header p {
      opacity: 0.9;
      font-size: 1.1em;
    }

    .content {
      padding: 30px;
    }

    .topology-container {
      margin-top: 20px;
      padding: 15px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      background-color: #f9fafb;
    }

    .section {
      margin-bottom: 40px;
    }

    .section h2 {
      color: #333;
      margin-bottom: 20px;
      font-size: 1.8em;
      border-bottom: 2px solid #4a90e2;
      padding-bottom: 10px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }

    .card {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 20px;
      border: 1px solid #e9ecef;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .card h3 {
      color: #4a90e2;
      margin-bottom: 15px;
    }

    .btn {
      background: linear-gradient(135deg, #4a90e2, #357abd);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s;
      text-decoration: none;
      display: inline-block;
      margin: 5px;
    }

    .btn:hover {
      background: linear-gradient(135deg, #357abd, #2968a3);
      transform: translateY(-1px);
    }

    .btn.danger {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
    }

    .btn.success {
      background: linear-gradient(135deg, #27ae60, #229954);
    }

    .status {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 15px;
      font-size: 0.9em;
      margin: 5px;
    }

    .status.loading {
      background: #ffeaa7;
      color: #d63031;
    }

    .status.success {
      background: #55efc4;
      color: #00b894;
    }

    .status.error {
      background: #fd79a8;
      color: #e84393;
    }

    .log {
      background: #2d3748;
      color: #e2e8f0;
      padding: 15px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 10px;
    }

    .input-group {
      margin-bottom: 15px;
    }

    .input-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #333;
    }

    .input-group input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-item {
      text-align: center;
      background: linear-gradient(135deg, #a8e6cf, #7fcdcd);
      padding: 20px;
      border-radius: 10px;
      color: white;
    }

    .stat-number {
      font-size: 2em;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 0.9em;
      opacity: 0.9;
    }

    .nav-card {
      text-align: center;
      border: 2px solid #e5e7eb;
      transition: all 0.3s ease;
    }

    .nav-card:hover {
      border-color: #4a90e2;
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .nav-card .btn {
      margin-top: 15px;
      width: auto;
      display: inline-block;
    }

    .mac-result {
      background: #f0f8ff;
      border-left: 4px solid #4a90e2;
      padding: 10px;
      margin: 8px 0;
      border-radius: 4px;
    }

    .vlan-stats div {
      padding: 5px 0;
      border-bottom: 1px solid #eee;
    }

    .vlan-stats div:last-child {
      border-bottom: none;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>üåê Network Scheme L2</h1>
      <p>–°–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª—ñ–∑—É –º–µ—Ä–µ–∂–µ–≤–æ—ó —Ç–æ–ø–æ–ª–æ–≥—ñ—ó —Ç–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó —Å—Ö–µ–º VLAN</p>
    </div>

    <div class="content">
      <!-- Statistics -->
      <div class="section">
        <h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
        <div class="stats" id="stats">
          <div class="stat-item">
            <div class="stat-number" id="deviceCount">-</div>
            <div class="stat-label">–ü—Ä–∏—Å—Ç—Ä–æ—ó</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" id="vlanCount">-</div>
            <div class="stat-label">VLAN</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" id="macCount">-</div>
            <div class="stat-label">MAC –∞–¥—Ä–µ—Å–∏</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" id="portCount">-</div>
            <div class="stat-label">–ü–æ—Ä—Ç–∏</div>
          </div>
        </div>
      </div>

      <!-- –ù–∞–≤—ñ–≥–∞—Ü—ñ—è -->
      <div class="section">
        <h2>üß≠ –ù–∞–≤—ñ–≥–∞—Ü—ñ—è</h2>
        <div class="grid">
          <div class="card nav-card">
            <h3>üìÅ –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –¥–∞–Ω–∏–º–∏</h3>
            <p>–Ü–º–ø–æ—Ä—Ç –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π, MAC —Ç–∞–±–ª–∏—Ü—å —Ç–∞ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –±–∞–∑–æ—é –¥–∞–Ω–∏—Ö</p>
            <a href="/import.html" class="btn">–ü–µ—Ä–µ–π—Ç–∏ –¥–æ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è ‚Üí</a>
          </div>

          <div class="card nav-card">
            <h3>üñ•Ô∏è –ü—Ä–∏—Å—Ç—Ä–æ—ó</h3>
            <p>–ü–µ—Ä–µ–≥–ª—è–¥ —Ç–∞ –∞–Ω–∞–ª—ñ–∑ –º–µ—Ä–µ–∂–µ–≤–∏—Ö –ø—Ä–∏—Å—Ç—Ä–æ—ó–≤</p>
            <a href="/devices.html" class="btn">–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –ø—Ä–∏—Å—Ç—Ä–æ—ó ‚Üí</a>
          </div>

          <div class="card nav-card">
            <h3>üåê VLAN —Ç–æ–ø–æ–ª–æ–≥—ñ—è</h3>
            <p>–Ü–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∏–π –ø–µ—Ä–µ–≥–ª—è–¥ VLAN —Ç–∞ —ó—Ö –∑–≤'—è–∑–∫—ñ–≤</p>
            <a href="/vlans.html" class="btn">–í—ñ–¥–∫—Ä–∏—Ç–∏ VLAN ‚Üí</a>
          </div>
        </div>
      </div>

      <!-- –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è —Å—Ö–µ–º -->
      <div class="section">
        <h2>üé® –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è —Å—Ö–µ–º</h2>
        <div class="grid">
          <div class="card">
            <h3>üìä HTML —Å—Ö–µ–º–∞ VLAN</h3>
            <p>–ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –¥–µ—Ç–∞–ª—å–Ω–æ—ó —Å—Ö–µ–º–∏ –ø—Ä–æ—Ö–æ–¥–∂–µ–Ω–Ω—è VLAN —á–µ—Ä–µ–∑ –ø—Ä–∏—Å—Ç—Ä–æ—ó</p>

            <div class="input-group">
              <label for="vlanId">VLAN ID:</label>
              <input type="number" id="vlanId" placeholder="–í–≤–µ–¥—ñ—Ç—å ID VLAN (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, 13)" value="13">
            </div>

            <button class="btn success" onclick="generateVlanScheme()">–ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ —Å—Ö–µ–º—É</button>
            <button class="btn" onclick="viewVlanTopology()">–ü–æ–∫–∞–∑–∞—Ç–∏ —Ç–æ–ø–æ–ª–æ–≥—ñ—é (JSON)</button>
            <button class="btn" onclick="viewVlanMacs()">–ü–æ–∫–∞–∑–∞—Ç–∏ MAC –∞–¥—Ä–µ—Å–∏</button>
          </div>
        </div>
      </div>

      <!-- –ê–Ω–∞–ª—ñ–∑ –º–µ—Ä–µ–∂—ñ -->
      <div class="section">
        <h2>üîç –ê–Ω–∞–ª—ñ–∑ –º–µ—Ä–µ–∂—ñ</h2>
        <div class="grid">
          <div class="card">
            <h3>ÔøΩ –ü–æ—à—É–∫ MAC –∞–¥—Ä–µ—Å–∏</h3>
            <p>–ó–Ω–∞–π—Ç–∏ –¥–µ –∑–Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è MAC –∞–¥—Ä–µ—Å–∞ –≤ –º–µ—Ä–µ–∂—ñ</p>

            <div class="input-group">
              <label for="macSearch">MAC –∞–¥—Ä–µ—Å–∞:</label>
              <input type="text" id="macSearch" placeholder="xx:xx:xx:xx:xx:xx –∞–±–æ xxxxxxxxxxxx">
            </div>

            <button class="btn" onclick="searchMacAddress()">–ó–Ω–∞–π—Ç–∏ MAC</button>
            <div id="macSearchResults"></div>
          </div>

          <div class="card">
            <h3>ÔøΩ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ VLAN</h3>
            <p>–î–µ—Ç–∞–ª—å–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–π VLAN</p>

            <div class="input-group">
              <label for="vlanStatsId">VLAN ID:</label>
              <input type="number" id="vlanStatsId" placeholder="–í–≤–µ–¥—ñ—Ç—å ID VLAN">
            </div>

            <button class="btn" onclick="showVlanStats()">–ü–æ–∫–∞–∑–∞—Ç–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
            <div id="vlanStatsResults"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
  <div class="section">
    <h2>üìù –†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h2>
    <div id="results">
      <p>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–ø–µ—Ä–∞—Ü–∏–π –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å...</p>
    </div>
  </div>
  </div>
  </div>

  <script>
    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.onload = function () {
      loadStats();
    };

    async function loadStats() {
      try {
        const stats = await fetch('/api/stats').then(r => r.json());

        if (stats.success) {
          document.getElementById('deviceCount').textContent = stats.data.devices;
          document.getElementById('vlanCount').textContent = stats.data.vlans;
          document.getElementById('macCount').textContent = stats.data.macs;
          document.getElementById('portCount').textContent = stats.data.ports;
        }

      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }

    // –ü–æ—à—É–∫ MAC –∞–¥—Ä–µ—Å–∏
    async function searchMacAddress() {
      const macInput = document.getElementById('macSearch');
      const resultsDiv = document.getElementById('macSearchResults');
      const macAddress = macInput.value.trim();

      if (!macAddress) {
        resultsDiv.innerHTML = '<span class="status error">–í–≤–µ–¥—ñ—Ç—å MAC –∞–¥—Ä–µ—Å—É</span>';
        return;
      }

      try {
        resultsDiv.innerHTML = '<span class="status loading">–ü–æ—à—É–∫...</span>';

        // –ù–æ—Ä–º–∞–ª—ñ–∑—É—î–º–æ MAC –∞–¥—Ä–µ—Å—É
        const normalizedMac = macAddress.replace(/[:-]/g, '').toLowerCase();

        const response = await fetch(`/api/macs/${normalizedMac}`);
        const result = await response.json();

        if (result.success && result.data.length > 0) {
          let html = '<div class="log"><h4>–ó–Ω–∞–π–¥–µ–Ω–æ MAC –∞–¥—Ä–µ—Å—É:</h4>';
          result.data.forEach(entry => {
            html += `
              <div class="mac-result">
                <strong>–ü—Ä–∏—Å—Ç—Ä—ñ–π:</strong> ${entry.device_ip} (${entry.device_hostname || 'Unknown'})<br>
                <strong>–ü–æ—Ä—Ç:</strong> ${entry.port_name}<br>
                <strong>VLAN:</strong> ${entry.vlan_id}<br>
                <strong>–¢–∏–ø:</strong> ${entry.vlan_mode || 'Unknown'}
              </div>`;
          });
          html += '</div>';
          resultsDiv.innerHTML = html;
        } else {
          resultsDiv.innerHTML = '<span class="status error">MAC –∞–¥—Ä–µ—Å—É –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</span>';
        }
      } catch (error) {
        resultsDiv.innerHTML = `<span class="status error">–ü–æ–º–∏–ª–∫–∞: ${error.message}</span>`;
      }
    }

    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ VLAN
    async function showVlanStats() {
      const vlanInput = document.getElementById('vlanStatsId');
      const resultsDiv = document.getElementById('vlanStatsResults');
      const vlanId = vlanInput.value.trim();

      if (!vlanId) {
        resultsDiv.innerHTML = '<span class="status error">–í–≤–µ–¥—ñ—Ç—å ID VLAN</span>';
        return;
      }

      try {
        resultsDiv.innerHTML = '<span class="status loading">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</span>';

        const [topology, macs] = await Promise.all([
          fetch(`/api/vlans/${vlanId}/topology`).then(r => r.json()),
          fetch(`/api/vlans/${vlanId}/macs`).then(r => r.json())
        ]);

        if (topology.success && macs.success) {
          const deviceCount = topology.data.devices?.length || 0;
          const macCount = macs.data?.length || 0;

          let html = `
            <div class="log">
              <h4>VLAN ${vlanId} - ${topology.data.vlan_name || 'Unknown'}</h4>
              <div class="vlan-stats">
                <div><strong>–ü—Ä–∏—Å—Ç—Ä–æ—ó–≤:</strong> ${deviceCount}</div>
                <div><strong>MAC –∞–¥—Ä–µ—Å:</strong> ${macCount}</div>
                <div><strong>–û–ø–∏—Å:</strong> ${topology.data.vlan_description || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ'}</div>
              </div>
              <div style="margin-top: 15px;">
                <button class="btn" onclick="window.open('/api/vlans/${vlanId}/scheme', '_blank')">
                  –í—ñ–¥–∫—Ä–∏—Ç–∏ –ø–æ–≤–Ω—É —Å—Ö–µ–º—É
                </button>
              </div>
            </div>`;

          resultsDiv.innerHTML = html;
        } else {
          resultsDiv.innerHTML = '<span class="status error">VLAN –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</span>';
        }
      } catch (error) {
        resultsDiv.innerHTML = `<span class="status error">–ü–æ–º–∏–ª–∫–∞: ${error.message}</span>`;
      }
    }

    function generateVlanScheme(vlanId) {
      if (!vlanId) {
        vlanId = document.getElementById('vlanId').value;
      }

      if (!vlanId) {
        alert('–í–≤–µ–¥—ñ—Ç—å VLAN ID');
        return;
      }

      window.open(`/api/vlans/${vlanId}/scheme`, '_blank');
    }

    async function viewVlanTopology(vlanId) {
      if (!vlanId) {
        vlanId = document.getElementById('vlanId').value;
      }

      if (!vlanId) {
        alert('Enter VLAN ID');
        return;
      }

      try {
        const response = await fetch(`/api/vlans/${vlanId}/topology`);
        const result = await response.json();

        if (result.success) {
          const resultsDiv = document.getElementById('results');
          resultsDiv.innerHTML = `<h3>üîó Network Topology VLAN ${vlanId}</h3>`;

          // Create topology visualization container
          const topologyContainer = document.createElement('div');
          topologyContainer.id = 'topology-visualization';
          topologyContainer.className = 'topology-container';
          resultsDiv.appendChild(topologyContainer);

          // Visualize topology
          visualizeNetworkTopology([result.data]);
        } else {
          alert('Error: ' + result.error);
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    // Network Topology Visualization with Source/Transit Detection
    function visualizeNetworkTopology(data) {
      const container = document.getElementById('topology-visualization')
      container.innerHTML = ''

      if (!data || data.length === 0) {
        container.innerHTML = '<p style="color: #666;">No topology data available</p>'
        return
      }

      // Create main topology container
      const topologyDiv = document.createElement('div')
      topologyDiv.style.display = 'flex'
      topologyDiv.style.flexDirection = 'column'
      topologyDiv.style.gap = '20px'

      data.forEach(item => {
        const vlanSection = document.createElement('div')
        vlanSection.style.border = '1px solid #ddd'
        vlanSection.style.borderRadius = '8px'
        vlanSection.style.padding = '15px'
        vlanSection.style.backgroundColor = '#f9f9f9'

        // VLAN Header
        const vlanHeader = document.createElement('h3')
        vlanHeader.style.margin = '0 0 15px 0'
        vlanHeader.style.color = '#2563eb'
        vlanHeader.textContent = item.vlan_name || ('VLAN ' + item.vlan_id)
        vlanSection.appendChild(vlanHeader)

        // Device grid
        if (item.devices && item.devices.length > 0) {
          const deviceGrid = document.createElement('div')
          deviceGrid.style.display = 'grid'
          deviceGrid.style.gridTemplateColumns = 'repeat(auto-fit, minmax(300px, 1fr))'
          deviceGrid.style.gap = '15px'

          item.devices.forEach(device => {
            const deviceCard = createDeviceCard(device)
            deviceGrid.appendChild(deviceCard)
          })

          vlanSection.appendChild(deviceGrid)
        }

        topologyDiv.appendChild(vlanSection)
      })

      container.appendChild(topologyDiv)
    }

    // Create device card with ports and MAC addresses
    function createDeviceCard(device) {
      const card = document.createElement('div')
      card.style.backgroundColor = 'white'
      card.style.border = '1px solid #ddd'
      card.style.borderRadius = '8px'
      card.style.padding = '15px'
      card.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)'

      // Device header
      const header = document.createElement('div')
      header.style.display = 'flex'
      header.style.alignItems = 'center'
      header.style.marginBottom = '15px'

      const deviceIcon = document.createElement('div')
      deviceIcon.style.width = '32px'
      deviceIcon.style.height = '32px'
      deviceIcon.style.backgroundColor = '#dbeafe'
      deviceIcon.style.borderRadius = '50%'
      deviceIcon.style.display = 'flex'
      deviceIcon.style.alignItems = 'center'
      deviceIcon.style.justifyContent = 'center'
      deviceIcon.style.marginRight = '12px'
      deviceIcon.innerHTML = 'üñ•Ô∏è'

      const deviceInfo = document.createElement('div')
      deviceInfo.innerHTML = `
                <div style="font-weight: 600; color: #1f2937;">${device.hostname || 'Unknown Device'}</div>
                <div style="font-size: 14px; color: #6b7280;">${device.ip_address}</div>
                <div style="font-size: 12px; color: #9ca3af;">${device.device_type || 'Switch'}</div>
            `

      header.appendChild(deviceIcon)
      header.appendChild(deviceInfo)
      card.appendChild(header)

      // Ports section
      if (device.ports && device.ports.length > 0) {
        const portsSection = document.createElement('div')
        portsSection.style.display = 'flex'
        portsSection.style.flexDirection = 'column'
        portsSection.style.gap = '8px'

        device.ports.forEach(port => {
          const portCard = createPortCard(port)
          portsSection.appendChild(portCard)
        })

        card.appendChild(portsSection)
      }

      return card
    }

    // Create port card with MAC addresses and topology info
    function createPortCard(port) {
      const portDiv = document.createElement('div')
      portDiv.style.border = '1px solid #e5e7eb'
      portDiv.style.borderRadius = '6px'
      portDiv.style.padding = '12px'
      portDiv.style.backgroundColor = '#f9fafb'

      // Port header
      const portHeader = document.createElement('div')
      portHeader.style.display = 'flex'
      portHeader.style.justifyContent = 'space-between'
      portHeader.style.alignItems = 'center'
      portHeader.style.marginBottom = '8px'

      const portInfo = document.createElement('div')
      portInfo.style.fontWeight = '500'
      portInfo.style.fontSize = '14px'

      // Show port type for OLT EPON interfaces
      const isEponPort = port.port_number && /epon[\d\-/:.]/.test(port.port_number)
      const portTypeIndicator = isEponPort ? ' üì°' : ''
      portInfo.textContent = `Port ${port.port_number}${portTypeIndicator}`

      const portMode = document.createElement('span')
      portMode.style.padding = '2px 8px'
      portMode.style.borderRadius = '4px'
      portMode.style.fontSize = '12px'
      const modeColor = getModeColor(port.mode)
      portMode.style.backgroundColor = modeColor.bg
      portMode.style.color = modeColor.text
      portMode.textContent = port.mode || 'unknown'

      portHeader.appendChild(portInfo)
      portHeader.appendChild(portMode)
      portDiv.appendChild(portHeader)

      // Port description
      if (port.port_description) {
        const description = document.createElement('div')
        description.style.fontSize = '12px'
        description.style.color = '#6b7280'
        description.style.marginBottom = '8px'
        description.textContent = port.port_description
        portDiv.appendChild(description)
      }

      // MAC addresses with topology indicators
      if (port.mac_addresses && port.mac_addresses.length > 0) {
        const macSection = document.createElement('div')
        macSection.style.display = 'flex'
        macSection.style.flexDirection = 'column'
        macSection.style.gap = '4px'

        // Group MACs by source/transit
        const sourceMacs = port.mac_addresses.filter(mac => mac.is_source)
        const transitMacs = port.mac_addresses.filter(mac => mac.is_source === false)
        const unknownMacs = port.mac_addresses.filter(mac => mac.is_source === null)

        // Source MACs
        if (sourceMacs.length > 0) {
          const sourceHeader = document.createElement('div')
          sourceHeader.style.fontSize = '12px'
          sourceHeader.style.fontWeight = '500'
          sourceHeader.style.color = '#059669'
          sourceHeader.style.marginTop = '8px'
          sourceHeader.textContent = `Source Devices (${sourceMacs.length})`
          macSection.appendChild(sourceHeader)

          sourceMacs.forEach(mac => {
            const macDiv = createMacAddressDiv(mac, 'source')
            macSection.appendChild(macDiv)
          })
        }

        // Transit MACs
        if (transitMacs.length > 0) {
          const transitHeader = document.createElement('div')
          transitHeader.style.fontSize = '12px'
          transitHeader.style.fontWeight = '500'
          transitHeader.style.color = '#d97706'
          transitHeader.style.marginTop = '8px'
          transitHeader.textContent = `Transit Path (${transitMacs.length})`
          macSection.appendChild(transitHeader)

          transitMacs.forEach(mac => {
            const macDiv = createMacAddressDiv(mac, 'transit')
            macSection.appendChild(macDiv)
          })
        }

        // Unknown MACs
        if (unknownMacs.length > 0) {
          const unknownHeader = document.createElement('div')
          unknownHeader.style.fontSize = '12px'
          unknownHeader.style.fontWeight = '500'
          unknownHeader.style.color = '#374151'
          unknownHeader.style.marginTop = '8px'
          unknownHeader.textContent = `Unanalyzed (${unknownMacs.length})`
          macSection.appendChild(unknownHeader)

          unknownMacs.forEach(mac => {
            const macDiv = createMacAddressDiv(mac, 'unknown')
            macSection.appendChild(macDiv)
          })
        }

        portDiv.appendChild(macSection)
      }

      return portDiv
    }

    // Create MAC address div with topology indicators
    function createMacAddressDiv(mac, type) {
      const macDiv = document.createElement('div')
      macDiv.style.display = 'flex'
      macDiv.style.alignItems = 'center'
      macDiv.style.justifyContent = 'space-between'
      macDiv.style.padding = '8px'
      macDiv.style.borderRadius = '4px'
      macDiv.style.fontSize = '12px'
      const typeColor = getMacTypeColor(type)
      macDiv.style.backgroundColor = typeColor.bg
      macDiv.style.border = `1px solid ${typeColor.border}`

      const macInfo = document.createElement('div')
      macInfo.style.display = 'flex'
      macInfo.style.alignItems = 'center'
      macInfo.style.gap = '8px'

      // Topology indicator
      const indicator = document.createElement('div')
      indicator.style.width = '8px'
      indicator.style.height = '8px'
      indicator.style.borderRadius = '50%'
      indicator.style.backgroundColor = getIndicatorColor(type)

      const macText = document.createElement('code')
      macText.style.fontFamily = 'monospace'
      macText.style.fontSize = '11px'
      macText.textContent = mac.mac_address

      macInfo.appendChild(indicator)
      macInfo.appendChild(macText)

      // Additional info
      const additionalInfo = document.createElement('div')
      additionalInfo.style.textAlign = 'right'
      additionalInfo.style.fontSize = '11px'

      if (mac.client_type && mac.client_type !== 'unknown') {
        const clientType = document.createElement('div')
        clientType.style.color = '#6b7280'
        clientType.textContent = mac.client_type.replace('_', ' ')
        additionalInfo.appendChild(clientType)
      }

      if (type === 'transit' && mac.hop_count !== null && mac.hop_count !== undefined) {
        const hopCount = document.createElement('div')
        hopCount.style.color = '#d97706'
        hopCount.textContent = `${mac.hop_count} hops`
        additionalInfo.appendChild(hopCount)
      } else if (type === 'transit') {
        const transitNote = document.createElement('div')
        transitNote.style.color = '#d97706'
        transitNote.textContent = 'transit path'
        additionalInfo.appendChild(transitNote)
      }

      macDiv.appendChild(macInfo)
      macDiv.appendChild(additionalInfo)

      return macDiv
    }

    // Helper functions for styling
    function getModeColor(mode) {
      switch (mode) {
        case 'access': return { bg: '#dcfce7', text: '#166534' }
        case 'trunk': return { bg: '#dbeafe', text: '#1e40af' }
        case 'hybrid': return { bg: '#f3e8ff', text: '#7c3aed' }
        default: return { bg: '#f3f4f6', text: '#374151' }
      }
    }

    function getMacTypeColor(type) {
      switch (type) {
        case 'source': return { bg: '#f0fdf4', border: '#bbf7d0' }
        case 'transit': return { bg: '#fffbeb', border: '#fed7aa' }
        default: return { bg: '#f9fafb', border: '#e5e7eb' }
      }
    }

    function getIndicatorColor(type) {
      switch (type) {
        case 'source': return '#10b981'
        case 'transit': return '#f59e0b'
        default: return '#9ca3af'
      }
    }

    async function viewVlanMacs(vlanId) {
      if (!vlanId) {
        vlanId = document.getElementById('vlanId').value;
      }

      if (!vlanId) {
        alert('–í–≤–µ–¥–∏—Ç–µ VLAN ID');
        return;
      }

      try {
        const response = await fetch(`/api/vlans/${vlanId}/macs`);
        const result = await response.json();

        if (result.success) {
          const resultsDiv = document.getElementById('results');
          let html = `<h3>üè∑Ô∏è MAC –∞–¥—Ä–µ—Å–∞ –≤ VLAN ${vlanId}</h3>`;

          if (result.data.length === 0) {
            html += '<p>MAC –∞–¥—Ä–µ—Å–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
          } else {
            html += '<div class="grid">';
            result.data.forEach(mac => {
              html += `
                                <div class="card">
                                    <h4>${mac.mac_address}</h4>
                                    ${mac.ip_address ? `<p><strong>IP:</strong> ${mac.ip_address}</p>` : ''}
                                    <p><strong>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ:</strong> ${mac.hostname || mac.device_ip}</p>
                                    <p><strong>–ü–æ—Ä—Ç:</strong> ${mac.port_number}</p>
                                    <p><strong>–¢–∏–ø:</strong> ${mac.client_type || 'unknown'}</p>
                                    ${mac.description ? `<p>${mac.description}</p>` : ''}
                                </div>
                            `;
            });
            html += '</div>';
          }

          resultsDiv.innerHTML = html;
        } else {
          alert('–ü–æ–º–∏–ª–∫–∞: ' + result.error);
        }
      } catch (error) {
        alert('–ü–æ–º–∏–ª–∫–∞: ' + error.message);
      }
    }

    async function viewDevice(deviceId) {
      try {
        const response = await fetch(`/api/devices/${deviceId}`);
        const result = await response.json();

        if (result.success) {
          const device = result.data;
          const resultsDiv = document.getElementById('results');

          let html = `
                        <h3>üì± ${device.hostname}</h3>
                        <p><strong>IP:</strong> ${device.ip_address}</p>
                        <p><strong>–¢–∏–ø:</strong> ${device.device_type}</p>
                        <p><strong>–ú–æ–¥–µ–ª—å:</strong> ${device.model}</p>
                        <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${device.status}</p>
                    `;

          if (device.ports && device.ports.length > 0) {
            html += '<h4>üîå –ü–æ—Ä—Ç—ã</h4><div class="grid">';
            device.ports.slice(0, 12).forEach(port => {
              html += `
                                <div class="card">
                                    <h5>Port ${port.port_number}</h5>
                                    <p><strong>–¢–∏–ø:</strong> ${port.port_type}</p>
                                    <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${port.status}</p>
                                    ${port.description ? `<p>${port.description}</p>` : ''}
                                </div>
                            `;
            });
            if (device.ports.length > 12) {
              html += `<div class="card"><p>–ò –µ—â–µ ${device.ports.length - 12} –ø–æ—Ä—Ç–æ–≤...</p></div>`;
            }
            html += '</div>';
          }

          resultsDiv.innerHTML = html;
        } else {
          alert('–ü–æ–º–∏–ª–∫–∞: ' + result.error);
        }
      } catch (error) {
        alert('–ü–æ–º–∏–ª–∫–∞: ' + error.message);
      }
    }
  </script>
</body>

</html>
